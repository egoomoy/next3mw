apiVersion: v1
kind: ConfigMap
metadata:
  name: ever-nginx-conf-server-block
  namespace: ever-ns
data:
  nginx-conf: |
    server {
      location /hls {
        autoindex off;   
        rewrite /([a-zA-Z0-9_\-]*)/([0-9]*)/([a-zA-Z0-9_\-]*)/([0-9]*)/(.*)\.(ts)$ /ts/$3/$4/$5.$6 last; 
        rewrite /([a-zA-Z0-9_\-]*)/([0-9]*)/([a-zA-Z0-9_\-]*)/([0-9]*)/(.*)\.(m3u8)$ /vod/$3/$4/$5.$6?md5=$1&expires=$2 last;  
        return  404;
      }

      location /vod {
        internal;           # 내부 요청만 가능하게 (rewrite)
        autoindex off;      # 디렉토리 목록을 표시합니다. 필요에 따라 off로 설정할 수 있습니다.

        secure_link $arg_md5,$arg_expires;           
        secure_link_md5 "$secure_link_expires $uri mysecret";
        
        if ($secure_link = "") { return 403; }
        if ($secure_link = "0") { return 410; }

        alias /mnt/vod;
      }

      location /ts {
        internal;           
        autoindex off;

        alias /mnt/vod;
      }

    }
